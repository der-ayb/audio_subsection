<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0d6efd">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoi2YXZgtiq2LfZgSDYp9mE2YLYsdii2YYg2KfZhNi12YjYqtmKIiwic2hvcnRfbmFtZSI6ItmF2YLYqti32YYg2KfZhNmC2LHYotmGIiwic3RhcnRfdXJsIjoiLi8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZjhmOWZhIiwidGhlbWVfY29sb3IiOiIjMGQ2ZWZkIiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0NzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgMTAwIDEwMCclM0UlM0NyZWN0IHdpZHRoPScxMDAnIGhlaWdodD0nMTAwJyBmaWxsPSclMjMwZDZlZmQnLyUzRSUzQ3RleHQgeD0nNTAnIHk9JzUwJyBmb250LXNpemU9JzYwJyBmaWxsPSd3aGl0ZScgdGV4dC1hbmNob3I9J21pZGRsZScgZHk9Jy4zZW0nJTNF2YIlM0MvdGV4dCUzRSUzQy9zdmclM0UiLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9LHsic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sLCUzQ3N2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxMDAgMTAwJyUzRSUzQ3JlY3Qgd2lkdGg9JzEwMCcgaGVpZ2h0PScxMDAnIGZpbGw9JyUyMzBkNmVmZCcvJTNFJTNDdGV4dCB4PSc1MCcgeT0nNTAnIGZvbnQtc2l6ZT0nNjAnIGZpbGw9J3doaXRlJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyBkeT0nLjNlbSclM0XZgiUzQy90ZXh0JTNFJTNDL3N2ZyUzRSIsInNpemVzIjoiNTEyeDUxMiIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn1dfQ==">
    <title>مقتطف القرآن الصوتي</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }
        
        .main-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 20px;
        }
        
        .btn-install {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border: none;
            color: white;
        }
        
        .btn-install:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(17, 153, 142, 0.4);
        }
        
        .online-indicator {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 1000;
        }
        
        .online {
            background: #d4edda;
            color: #155724;
        }
        
        .offline {
            background: #f8d7da;
            color: #721c24;
        }
        
        .form-select, .btn {
            border-radius: 10px;
        }
        
        .aya-select {
            font-family: 'Traditional Arabic', 'Arial', sans-serif;
            max-height: 200px;
        }
        
        .surah-checkbox {
            transition: background 0.2s;
            padding: 8px;
            border-radius: 5px;
        }
        
        .surah-checkbox:hover {
            background: #f8f9fa;
        }
        
        .surah-checkbox.downloaded {
            background: #d4edda;
        }
        
        audio {
            width: 100%;
            border-radius: 10px;
        }
        
        .accordion-button:not(.collapsed) {
            background: #e7f3ff;
            color: #0c5460;
        }
        
        .progress {
            border-radius: 10px;
            height: 25px;
        }
        
        .badge-count {
            font-size: 0.8rem;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div class="online-indicator online" id="onlineIndicator">
        <i class="bi bi-wifi"></i> متصل بالإنترنت
    </div>

    <div class="main-container">
        <!-- Install Card -->
        <div class="card mb-3 d-none" id="installCard">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="mb-1"><i class="bi bi-download"></i> تثبيت التطبيق</h6>
                        <small class="text-muted">احصل على وصول سريع من الشاشة الرئيسية</small>
                    </div>
                    <button class="btn btn-install btn-sm" id="installBtn">
                        <i class="bi bi-plus-circle"></i> تثبيت
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Card -->
        <div class="card">
            <div class="card-header text-center">
                <h2 class="mb-0"><i class="bi bi-music-note-beamed"></i> مقتطف القرآن الصوتي</h2>
            </div>
            
            <div class="card-body">
                <!-- Info Alert -->
                <div class="alert alert-info mt-3 d-none" id="infoBox" role="alert"></div>
                
                <!-- Status Alert -->
                <div class="alert mt-3 d-none" id="statusAlert" role="alert"></div>
                <!-- Offline Download Section -->
                <div class="accordion mb-4" id="offlineAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#offlineCollapse">
                                <i class="bi bi-cloud-download mx-2"></i>
                                تحميل السور للاستخدام بدون إنترنت
                                <span class="badge bg-primary badge-count mx-2" id="storedCount">0</span>
                            </button>
                        </h2>
                        <div id="offlineCollapse" class="accordion-collapse collapse" data-bs-parent="#offlineAccordion">
                            <div class="accordion-body">
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between mb-2">
                                        <button class="btn btn-sm btn-outline-primary" id="selectAllBtn">
                                            <i class="bi bi-check-all"></i> تحديد الكل
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" id="deselectAllBtn">
                                            <i class="bi bi-x-circle"></i> إلغاء التحديد
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" id="clearAllBtn">
                                            <i class="bi bi-trash"></i> حذف الكل
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="surahCheckboxes" class="mb-3" style="max-height: 300px; overflow-y: auto;"></div>
                                
                                <button class="btn btn-info w-100" id="downloadOfflineBtn">
                                    <i class="bi bi-download"></i> تحميل السور المحددة
                                </button>
                                
                                <div class="progress mt-3 d-none" id="downloadProgress">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" 
                                         id="progressBar" 
                                         style="width: 0%">0%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Selection Form -->
                <div class="mb-3">
                    <label for="surahSelect" class="form-label fw-bold">
                        <i class="bi bi-book"></i> السورة:
                    </label>
                    <select id="surahSelect" class="form-select form-select-lg">
                        <option value="">جاري التحميل...</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="startAyaSelect" class="form-label fw-bold">
                        <i class="bi bi-play-circle"></i> الآية الأولى:
                    </label>
                    <select id="startAyaSelect" class="form-select aya-select">
                        <option value="">اختر السورة أولاً...</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="endAyaSelect" class="form-label fw-bold">
                        <i class="bi bi-stop-circle"></i> الآية الأخيرة:
                    </label>
                    <select id="endAyaSelect" class="form-select aya-select">
                        <option value="">اختر الآية الأولى أولاً...</option>
                    </select>
                </div>
                
                <button id="downloadBtn" class="btn btn-primary btn-lg w-100" disabled>
                    <i class="bi bi-download"></i> تحميل المقطع
                </button>
                
                <!-- Audio Preview -->
                <audio id="preview" controls class="mt-3 d-none"></audio>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <script>
        let db = null;
        let deferredPrompt = null;
        const DB_NAME = 'quran_audio_cache';
        const DB_VERSION = 3;
        const BASE_URL = 'https://everyayah.com/data/warsh/warsh_yassin_al_jazaery_64kbps/';
        
        const elements = {
            surahSelect: document.getElementById('surahSelect'),
            startAyaSelect: document.getElementById('startAyaSelect'),
            endAyaSelect: document.getElementById('endAyaSelect'),
            downloadBtn: document.getElementById('downloadBtn'),
            statusAlert: document.getElementById('statusAlert'),
            infoBox: document.getElementById('infoBox'),
            previewAudio: document.getElementById('preview'),
            installBtn: document.getElementById('installBtn'),
            installCard: document.getElementById('installCard'),
            downloadOfflineBtn: document.getElementById('downloadOfflineBtn'),
            downloadProgress: document.getElementById('downloadProgress'),
            progressBar: document.getElementById('progressBar'),
            storedCount: document.getElementById('storedCount'),
            surahCheckboxes: document.getElementById('surahCheckboxes'),
            onlineIndicator: document.getElementById('onlineIndicator'),
            selectAllBtn: document.getElementById('selectAllBtn'),
            deselectAllBtn: document.getElementById('deselectAllBtn'),
            clearAllBtn: document.getElementById('clearAllBtn')
        };

        // Online/Offline Detection
        function updateOnlineStatus() {
            const isOnline = navigator.onLine;
            elements.onlineIndicator.className = `online-indicator ${isOnline ? 'online' : 'offline'}`;
            elements.onlineIndicator.innerHTML = isOnline 
                ? '<i class="bi bi-wifi"></i> متصل بالإنترنت'
                : '<i class="bi bi-wifi-off"></i> غير متصل';
        }

        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus();

        // PWA Install
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            elements.installCard.classList.remove('d-none');
        });

        elements.installBtn.addEventListener('click', async () => {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                elements.installCard.classList.add('d-none');
            }
            deferredPrompt = null;
        });

        // IndexedDB functions
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                
                request.onsuccess = () => {
                    const db = request.result;
                    
                    // Check if object store exists
                    if (!db.objectStoreNames.contains('ayahs')) {
                        // Close and reopen with higher version to trigger upgrade
                        db.close();
                        const newVersion = db.version + 1;
                        const upgradeRequest = indexedDB.open(DB_NAME, newVersion);
                        
                        upgradeRequest.onupgradeneeded = (e) => {
                            const upgradeDb = e.target.result;
                            if (!upgradeDb.objectStoreNames.contains('ayahs')) {
                                upgradeDb.createObjectStore('ayahs', { keyPath: 'ayahId' });
                            }
                        };
                        
                        upgradeRequest.onsuccess = () => resolve(upgradeRequest.result);
                        upgradeRequest.onerror = () => reject(upgradeRequest.error);
                    } else {
                        resolve(db);
                    }
                };
                
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    
                    // Delete old object stores if they exist
                    if (db.objectStoreNames.contains('audio')) {
                        db.deleteObjectStore('audio');
                    }
                    
                    // Create new object store
                    if (!db.objectStoreNames.contains('ayahs')) {
                        db.createObjectStore('ayahs', { keyPath: 'ayahId' });
                    }
                };
            });
        }

        async function saveAyahToCache(surah, ayah, arrayBuffer) {
            const db = await openDB();
            const ayahId = `${String(surah).padStart(3, '0')}${String(ayah).padStart(3, '0')}`;
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['ayahs'], 'readwrite');
                const store = transaction.objectStore('ayahs');
                const request = store.put({ ayahId, surah, ayah, data: arrayBuffer });
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        async function getAyahFromCache(surah, ayah) {
            const db = await openDB();
            const ayahId = `${String(surah).padStart(3, '0')}${String(ayah).padStart(3, '0')}`;
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['ayahs'], 'readonly');
                const store = transaction.objectStore('ayahs');
                const request = store.get(ayahId);
                request.onsuccess = () => resolve(request.result?.data || null);
                request.onerror = () => reject(request.error);
            });
        }

        async function getStoredSurahs() {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['ayahs'], 'readonly');
                const store = transaction.objectStore('ayahs');
                const request = store.getAll();
                request.onsuccess = () => {
                    const ayahs = request.result;
                    const surahs = [...new Set(ayahs.map(a => a.surah))];
                    resolve(surahs);
                };
                request.onerror = () => reject(request.error);
            });
        }

        async function getSurahAyahsFromCache(surah) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['ayahs'], 'readonly');
                const store = transaction.objectStore('ayahs');
                const request = store.getAll();
                request.onsuccess = () => {
                    const ayahs = request.result.filter(a => a.surah === surah);
                    resolve(ayahs.map(a => a.ayah));
                };
                request.onerror = () => reject(request.error);
            });
        }

        async function deleteSurahFromCache(surah) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['ayahs'], 'readwrite');
                const store = transaction.objectStore('ayahs');
                const getAllRequest = store.getAll();
                
                getAllRequest.onsuccess = () => {
                    const ayahs = getAllRequest.result.filter(a => a.surah === surah);
                    let deleteCount = 0;
                    
                    ayahs.forEach(ayah => {
                        const deleteRequest = store.delete(ayah.ayahId);
                        deleteRequest.onsuccess = () => {
                            deleteCount++;
                            if (deleteCount === ayahs.length) {
                                resolve();
                            }
                        };
                    });
                    
                    if (ayahs.length === 0) resolve();
                };
                getAllRequest.onerror = () => reject(getAllRequest.error);
            });
        }

        async function clearAllCache() {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['ayahs'], 'readwrite');
                const store = transaction.objectStore('ayahs');
                const request = store.clear();
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        async function updateStoredSurahsList() {
            const stored = await getStoredSurahs();
            elements.storedCount.textContent = stored.length;
            
            const checkboxes = elements.surahCheckboxes.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                const surahNum = parseInt(cb.value);
                const container = cb.closest('.surah-checkbox');
                if (stored.includes(surahNum)) {
                    cb.checked = true;
                    container.classList.add('downloaded');
                } else {
                    cb.checked = false;
                    container.classList.remove('downloaded');
                }
            });
        }

        function showStatus(message, type = 'info') {
            const alertClass = `alert-${type}`;
            elements.statusAlert.className = `alert ${alertClass} mt-3`;
            elements.statusAlert.innerHTML = `<i class="bi bi-${type === 'success' ? 'check-circle' : type === 'danger' ? 'x-circle' : 'info-circle'}"></i> ${message}`;
            elements.statusAlert.classList.remove('d-none');
        }

        function showInfo(message) {
            elements.infoBox.innerHTML = `<i class="bi bi-info-circle"></i> ${message}`;
            elements.infoBox.classList.remove('d-none');
        }

        async function initDatabase() {
            try {
                showStatus('جاري تحميل قاعدة البيانات...', 'info');
                const SQL = await initSqlJs({
                    locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
                });

                const response = await fetch('https://der-ayb.github.io/quran_students/assets/quran.sqlite');
                const buffer = await response.arrayBuffer();
                db = new SQL.Database(new Uint8Array(buffer));
                
                loadSurahs();
                await updateStoredSurahsList();
                
                showStatus('تم تحميل قاعدة البيانات بنجاح!', 'success');
                setTimeout(() => elements.statusAlert.classList.add('d-none'), 2000);
            } catch (error) {
                showStatus(`خطأ في تحميل قاعدة البيانات: ${error.message}`, 'danger');
            }
        }

        function loadSurahs() {
            const result = db.exec('SELECT id_sura, sura, num_ayat FROM quran_index ORDER BY id_sura');
            
            if (result.length > 0) {
                elements.surahSelect.innerHTML = '';
                elements.surahCheckboxes.innerHTML = '';
                const rows = result[0].values;
                
                rows.forEach(row => {
                    const [id_sura, sura, num_ayat] = row;
                    
                    const option = document.createElement('option');
                    option.value = id_sura;
                    option.textContent = `${id_sura}. ${sura}`;
                    option.dataset.numAyat = num_ayat;
                    elements.surahSelect.appendChild(option);
                    
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'surah-checkbox form-check';
                    checkboxDiv.innerHTML = `
                        <input type="checkbox" class="form-check-input" id="surah_${id_sura}" value="${id_sura}">
                        <label class="form-check-label w-100" for="surah_${id_sura}">
                            ${id_sura}. ${sura}
                        </label>
                    `;
                    elements.surahCheckboxes.appendChild(checkboxDiv);
                });
                
                elements.surahSelect.value = '1';
                loadAyasForSurah();
            }
        }

        function loadAyasForSurah() {
            const surahId = parseInt(elements.surahSelect.value);
            if (!surahId) return;

            const result = db.exec(`SELECT ayah, text FROM quran_ayat WHERE sura = ${surahId} ORDER BY ayah`);
            
            if (result.length > 0) {
                elements.startAyaSelect.innerHTML = '';
                const rows = result[0].values;
                
                rows.forEach(row => {
                    const [ayah, text] = row;
                    const option = document.createElement('option');
                    option.value = ayah;
                    const truncatedText = text.length > 80 ? text.substring(0, 80) + '...' : text;
                    option.textContent = `${ayah}. ${truncatedText}`;
                    elements.startAyaSelect.appendChild(option);
                });
                
                elements.startAyaSelect.value = '1';
                updateEndAyaOptions();
            }
        }

        function updateEndAyaOptions() {
            const startAya = parseInt(elements.startAyaSelect.value);
            const surahId = parseInt(elements.surahSelect.value);
            
            if (!startAya || !surahId) return;

            const result = db.exec(`SELECT ayah, text FROM quran_ayat WHERE sura = ${surahId} AND ayah >= ${startAya} ORDER BY ayah`);
            
            if (result.length > 0) {
                elements.endAyaSelect.innerHTML = '';
                const rows = result[0].values;
                
                rows.forEach(row => {
                    const [ayah, text] = row;
                    const option = document.createElement('option');
                    option.value = ayah;
                    const truncatedText = text.length > 80 ? text.substring(0, 80) + '...' : text;
                    option.textContent = `${ayah}. ${truncatedText}`;
                    elements.endAyaSelect.appendChild(option);
                });
                
                const selectedOption = elements.surahSelect.options[elements.surahSelect.selectedIndex];
                const numAyat = parseInt(selectedOption.dataset.numAyat);
                elements.endAyaSelect.value = Math.min(parseInt(startAya) + 5, numAyat);
                
                elements.downloadBtn.disabled = false;
            }
        }

        elements.selectAllBtn.addEventListener('click', () => {
            const checkboxes = elements.surahCheckboxes.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
        });

        elements.deselectAllBtn.addEventListener('click', () => {
            const checkboxes = elements.surahCheckboxes.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
        });

        elements.clearAllBtn.addEventListener('click', async () => {
            if (!confirm('هل أنت متأكد من حذف جميع السور المحفوظة؟')) return;
            
            try {
                await clearAllCache();
                await updateStoredSurahsList();
                showStatus('تم حذف جميع السور المحفوظة', 'success');
            } catch (error) {
                showStatus(`خطأ في الحذف: ${error.message}`, 'danger');
            }
        });

        elements.downloadOfflineBtn.addEventListener('click', async () => {
            if (!navigator.onLine) {
                showStatus('يجب الاتصال بالإنترنت لتحميل السور', 'danger');
                return;
            }

            const checkboxes = elements.surahCheckboxes.querySelectorAll('input[type="checkbox"]:checked');
            const selectedSurahs = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            if (selectedSurahs.length === 0) {
                showStatus('الرجاء اختيار سورة واحدة على الأقل', 'danger');
                return;
            }
            
            elements.downloadOfflineBtn.disabled = true;
            elements.downloadProgress.classList.remove('d-none');
            
            let totalAyahs = 0;
            let downloadedAyahs = 0;
            
            for (const surahNum of selectedSurahs) {
                const result = db.exec(`SELECT num_ayat FROM quran_index WHERE id_sura = ${surahNum}`);
                if (result.length > 0) {
                    totalAyahs += result[0].values[0][0];
                }
            }
            
            for (const surahNum of selectedSurahs) {
                const result = db.exec(`SELECT num_ayat FROM quran_index WHERE id_sura = ${surahNum}`);
                if (result.length > 0) {
                    const numAyat = result[0].values[0][0];
                    
                    for (let ayah = 1; ayah <= numAyat; ayah++) {
                        try {
                            const ayahId = `${String(surahNum).padStart(3, '0')}${String(ayah).padStart(3, '0')}`;
                            const audioUrl = `${BASE_URL}${ayahId}.mp3`;
                            
                            const response = await fetch(audioUrl);
                            if (response.ok) {
                                const arrayBuffer = await response.arrayBuffer();
                                await saveAyahToCache(surahNum, ayah, arrayBuffer);
                            }
                            
                            downloadedAyahs++;
                            const progress = Math.round((downloadedAyahs / totalAyahs) * 100);
                            elements.progressBar.style.width = progress + '%';
                            elements.progressBar.textContent = `${progress}% - آية ${ayah}/${numAyat} من السورة ${surahNum}`;
                        } catch (error) {
                            console.error(`خطأ في تحميل الآية ${ayah} من السورة ${surahNum}:`, error);
                        }
                    }
                }
            }
            
            elements.progressBar.style.width = '100%';
            elements.progressBar.textContent = 'اكتمل التحميل!';
            await updateStoredSurahsList();
            
            setTimeout(() => {
                elements.downloadProgress.classList.add('d-none');
                elements.downloadOfflineBtn.disabled = false;
                showStatus('تم حفظ السور بنجاح!', 'success');
            }, 1500);
        });

        async function downloadAudioSegment() {
            const surahNumber = parseInt(elements.surahSelect.value);
            const startAya = parseInt(elements.startAyaSelect.value);
            const endAya = parseInt(elements.endAyaSelect.value);

            if (!surahNumber || !startAya || !endAya) {
                showStatus('الرجاء اختيار جميع الحقول', 'danger');
                return;
            }

            if (!db) {
                showStatus('قاعدة البيانات غير محملة بعد. الرجاء الانتظار...', 'danger');
                return;
            }

            try {
                elements.downloadBtn.disabled = true;
                elements.previewAudio.classList.add('d-none');
                elements.infoBox.classList.add('d-none');

                const ayahCount = endAya - startAya + 1;
                showInfo(`جاري تحميل ${ayahCount} آية...`);
                showStatus('جاري تحميل الآيات...', 'info');

                const audioBuffers = [];
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();

                for (let ayah = startAya; ayah <= endAya; ayah++) {
                    const currentAyah = ayah - startAya + 1;
                    showStatus(`جاري معالجة الآية ${currentAyah} من ${ayahCount}...`, 'info');

                    let arrayBuffer = await getAyahFromCache(surahNumber, ayah);

                    if (!arrayBuffer) {
                        if (!navigator.onLine) {
                            showStatus(`لا يوجد اتصال بالإنترنت والآية ${ayah} غير محفوظة`, 'danger');
                            elements.downloadBtn.disabled = false;
                            return;
                        }

                        const ayahId = `${String(surahNumber).padStart(3, '0')}${String(ayah).padStart(3, '0')}`;
                        const audioUrl = `${BASE_URL}${ayahId}.mp3`;

                        const response = await fetch(audioUrl);
                        if (!response.ok) throw new Error(`فشل تحميل الآية ${ayah}`);
                        arrayBuffer = await response.arrayBuffer();
                    }

                    const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                    audioBuffers.push(audioBuffer);
                }

                showStatus('جاري دمج الآيات...', 'info');

                const mergedBuffer = mergeAudioBuffers(audioContext, audioBuffers);

                showStatus('جاري ترميز الصوت...', 'info');

                const wavBlob = bufferToWave(mergedBuffer);

                const previewUrl = URL.createObjectURL(wavBlob);
                elements.previewAudio.src = previewUrl;
                elements.previewAudio.classList.remove('d-none');

                const a = document.createElement('a');
                a.href = previewUrl;
                a.download = `algerian-yassin.wav`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                showStatus('اكتمل التحميل! المعاينة متاحة أدناه.', 'success');
                showInfo(`تم دمج ${ayahCount} آية بنجاح`);
            } catch (error) {
                showStatus(`خطأ: ${error.message}`, 'danger');
                console.error(error);
            } finally {
                elements.downloadBtn.disabled = false;
            }
        }

        function mergeAudioBuffers(audioContext, buffers) {
            if (buffers.length === 0) {
                throw new Error('لا توجد ملفات صوتية للدمج');
            }

            const numberOfChannels = buffers[0].numberOfChannels;
            const sampleRate = buffers[0].sampleRate;

            let totalLength = 0;
            buffers.forEach(buffer => {
                totalLength += buffer.length;
            });

            const mergedBuffer = audioContext.createBuffer(
                numberOfChannels,
                totalLength,
                sampleRate
            );

            let offset = 0;
            buffers.forEach(buffer => {
                for (let channel = 0; channel < numberOfChannels; channel++) {
                    const sourceData = buffer.getChannelData(channel);
                    const targetData = mergedBuffer.getChannelData(channel);
                    
                    for (let i = 0; i < buffer.length; i++) {
                        targetData[offset + i] = sourceData[i];
                    }
                }
                offset += buffer.length;
            });

            return mergedBuffer;
        }

        function bufferToWave(audioBuffer) {
            const numChannels = audioBuffer.numberOfChannels;
            const sampleRate = audioBuffer.sampleRate;
            const format = 1;
            const bitDepth = 16;

            const length = audioBuffer.length * numChannels * 2;
            const buffer = new ArrayBuffer(44 + length);
            const view = new DataView(buffer);

            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + length, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, format, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * numChannels * bitDepth / 8, true);
            view.setUint16(32, numChannels * bitDepth / 8, true);
            view.setUint16(34, bitDepth, true);
            writeString(view, 36, 'data');
            view.setUint32(40, length, true);

            const channels = [];
            for (let i = 0; i < numChannels; i++) {
                channels.push(audioBuffer.getChannelData(i));
            }

            let offset = 44;
            for (let i = 0; i < audioBuffer.length; i++) {
                for (let channel = 0; channel < numChannels; channel++) {
                    const sample = Math.max(-1, Math.min(1, channels[channel][i]));
                    view.setInt16(offset, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
                    offset += 2;
                }
            }

            return new Blob([buffer], { type: 'audio/wav' });
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        elements.surahSelect.addEventListener('change', loadAyasForSurah);
        elements.startAyaSelect.addEventListener('change', updateEndAyaOptions);
        elements.downloadBtn.addEventListener('click', downloadAudioSegment);

        initDatabase();
    </script>
</body>
</html>