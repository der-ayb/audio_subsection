<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#007bff">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoi2YXZgtiy2LUg2KfZhNmC2LHYotmGINin2YTYtdmI2KrZiiIsInNob3J0X25hbWUiOiLZhdmC2LXYpyDYp9mE2YLYsdii2YYiLCJzdGFydF91cmwiOiIuLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmNWY1ZjUiLCJ0aGVtZV9jb2xvciI6IiMwMDdiZmYiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sLCUzQ3N2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxMDAgMTAwJyUzRSUzQ3JlY3Qgd2lkdGg9JzEwMCcgaGVpZ2h0PScxMDAnIGZpbGw9JyUyMzAwN2JmZicvJTNFJTNDdGV4dCB4PSc1MCcgeT0nNTAnIGZvbnQtc2l6ZT0nNjAnIGZpbGw9J3doaXRlJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyBkeT0nLjNlbSclM0XZgiUzQy90ZXh0JTNFJTNDL3N2ZyUzRSIsInNpemVzIjoiMTkyeDE5MiIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn0seyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgdmlld0JveD0nMCAwIDEwMCAxMDAnJTNFJTNDcmVjdCB3aWR0aD0nMTAwJyBoZWlnaHQ9JzEwMCcgZmlsbD0nJTIzMDA3YmZmJy8lM0UlM0N0ZXh0IHg9JzUwJyB5PSc1MCcgZm9udC1zaXplPSc2MCcgZmlsbD0nd2hpdGUnIHRleHQtYW5jaG9yPSdtaWRkbGUnIGR5PScuM2VtJyUzRdmCJTNDL3RleHQlM0UlM0Mvc3ZnJTNFIiwic2l6ZXMiOiI1MTJ4NTEyIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwifV19">
    <title>مقتطف القرآن الصوتي</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 700px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h2 {
            margin-top: 0;
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .install-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        
        .install-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        
        .offline-section {
            background: #e7f3ff;
            border: 1px solid #b8daff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .offline-section h3 {
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .surah-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
        }
        
        .download-offline-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        
        .download-offline-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        label {
            display: block;
            margin: 15px 0 5px;
            font-weight: bold;
            color: #555;
        }
        
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            font-family: 'Traditional Arabic', 'Arial', sans-serif;
        }
        
        button {
            width: 100%;
            padding: 12px;
            margin-top: 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        button:hover:not(:disabled) {
            opacity: 0.9;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .info-box {
            background: #e7f3ff;
            color: #004085;
            border: 1px solid #b8daff;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            font-size: 14px;
            display: none;
        }
        
        audio {
            width: 100%;
            margin-top: 15px;
        }
        
        .progress {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
            display: none;
        }
        
        .progress-bar {
            height: 100%;
            background: #007bff;
            transition: width 0.3s;
            text-align: center;
            color: white;
            font-size: 12px;
            line-height: 20px;
        }
        
        .stored-surahs {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>مقتطف القرآن الصوتي</h2>
        
        <div id="installSection" class="install-section">
            <p>يمكنك تثبيت التطبيق على جهازك للوصول السريع</p>
            <button class="install-btn" id="installBtn">تثبيت التطبيق</button>
        </div>
        
        <div class="offline-section">
            <h3>تحميل السور للاستخدام بدون إنترنت</h3>
            <div id="surahCheckboxes"></div>
            <button class="download-offline-btn" id="downloadOfflineBtn">تحميل السور المحددة</button>
            <div class="progress" id="downloadProgress">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>
            <div class="stored-surahs" id="storedSurahs"></div>
        </div>
        
        <label for="surahSelect">السورة:</label>
        <select id="surahSelect">
            <option value="">جاري التحميل...</option>
        </select>
        
        <label for="startAyaSelect">الآية الأولى:</label>
        <select id="startAyaSelect">
            <option value="">اختر السورة أولاً...</option>
        </select>
        
        <label for="endAyaSelect">الآية الأخيرة:</label>
        <select id="endAyaSelect">
            <option value="">اختر الآية الأولى أولاً...</option>
        </select>
        
        <button id="downloadBtn" disabled>تحميل المقطع</button>
        
        <div id="infoBox" class="info-box"></div>
        <div id="status" class="status"></div>
        
        <audio id="preview" controls style="display: none;"></audio>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <script>
        let db = null;
        let deferredPrompt = null;
        const DB_NAME = 'quran_audio_cache';
        const DB_VERSION = 1;
        
        const surahSelect = document.getElementById('surahSelect');
        const startAyaSelect = document.getElementById('startAyaSelect');
        const endAyaSelect = document.getElementById('endAyaSelect');
        const downloadBtn = document.getElementById('downloadBtn');
        const statusDiv = document.getElementById('status');
        const infoBox = document.getElementById('infoBox');
        const previewAudio = document.getElementById('preview');
        const installBtn = document.getElementById('installBtn');
        const installSection = document.getElementById('installSection');
        const downloadOfflineBtn = document.getElementById('downloadOfflineBtn');
        const downloadProgress = document.getElementById('downloadProgress');
        const progressBar = document.getElementById('progressBar');
        const storedSurahs = document.getElementById('storedSurahs');
        const surahCheckboxes = document.getElementById('surahCheckboxes');

        // PWA Install
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installSection.style.display = 'block';
        });

        installBtn.addEventListener('click', async () => {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                installSection.style.display = 'none';
            }
            deferredPrompt = null;
        });

        // IndexedDB functions
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
                
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('audio')) {
                        db.createObjectStore('audio', { keyPath: 'surah' });
                    }
                };
            });
        }

        async function saveAudioToCache(surah, arrayBuffer) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['audio'], 'readwrite');
                const store = transaction.objectStore('audio');
                const request = store.put({ surah, data: arrayBuffer });
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        async function getAudioFromCache(surah) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['audio'], 'readonly');
                const store = transaction.objectStore('audio');
                const request = store.get(surah);
                
                request.onsuccess = () => resolve(request.result?.data || null);
                request.onerror = () => reject(request.error);
            });
        }

        async function getStoredSurahs() {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['audio'], 'readonly');
                const store = transaction.objectStore('audio');
                const request = store.getAllKeys();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function deleteAudioFromCache(surah) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['audio'], 'readwrite');
                const store = transaction.objectStore('audio');
                const request = store.delete(surah);
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        async function updateStoredSurahsList() {
            const stored = await getStoredSurahs();
            if (stored.length > 0) {
                storedSurahs.innerHTML = `السور المحفوظة (${stored.length}): ${stored.map(s => s).join(', ')}`;
            } else {
                storedSurahs.innerHTML = 'لا توجد سور محفوظة بعد';
            }
        }

        function showStatus(message, type) {
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
        }

        function showInfo(message) {
            infoBox.textContent = message;
            infoBox.style.display = 'block';
        }

        async function initDatabase() {
            try {
                showStatus('جاري تحميل قاعدة البيانات...', 'info');
                const SQL = await initSqlJs({
                    locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
                });

                const response = await fetch('https://der-ayb.github.io/quran_students/assets/quran.sqlite');
                const buffer = await response.arrayBuffer();
                db = new SQL.Database(new Uint8Array(buffer));
                
                loadSurahs();
                await updateStoredSurahsList();
                
                showStatus('تم تحميل قاعدة البيانات بنجاح!', 'success');
                setTimeout(() => statusDiv.style.display = 'none', 2000);
            } catch (error) {
                showStatus(`خطأ في تحميل قاعدة البيانات: ${error.message}`, 'error');
                console.error(error);
            }
        }

        function loadSurahs() {
            const result = db.exec('SELECT id_sura, sura, num_ayat FROM quran_index ORDER BY id_sura');
            
            if (result.length > 0) {
                surahSelect.innerHTML = '';
                surahCheckboxes.innerHTML = '';
                const rows = result[0].values;
                
                rows.forEach(row => {
                    const [id_sura, sura, num_ayat] = row;
                    
                    const option = document.createElement('option');
                    option.value = id_sura;
                    option.textContent = `${id_sura}. ${sura}`;
                    option.dataset.numAyat = num_ayat;
                    surahSelect.appendChild(option);
                    
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'surah-checkbox';
                    checkboxDiv.innerHTML = `
                        <input type="checkbox" id="surah_${id_sura}" value="${id_sura}">
                        <label for="surah_${id_sura}" style="margin: 0; font-weight: normal;">${id_sura}. ${sura}</label>
                    `;
                    surahCheckboxes.appendChild(checkboxDiv);
                });
                
                surahSelect.value = '1';
                loadAyasForSurah();
            }
        }

        function loadAyasForSurah() {
            const surahId = parseInt(surahSelect.value);
            if (!surahId) return;

            const result = db.exec(`SELECT ayah, text FROM quran_ayat WHERE sura = ${surahId} ORDER BY ayah`);
            
            if (result.length > 0) {
                startAyaSelect.innerHTML = '';
                const rows = result[0].values;
                
                rows.forEach(row => {
                    const [ayah, text] = row;
                    const option = document.createElement('option');
                    option.value = ayah;
                    const truncatedText = text.length > 80 ? text.substring(0, 80) + '...' : text;
                    option.textContent = `${ayah}. ${truncatedText}`;
                    startAyaSelect.appendChild(option);
                });
                
                startAyaSelect.value = '1';
                updateEndAyaOptions();
            }
        }

        function updateEndAyaOptions() {
            const startAya = parseInt(startAyaSelect.value);
            const surahId = parseInt(surahSelect.value);
            
            if (!startAya || !surahId) return;

            const result = db.exec(`SELECT ayah, text FROM quran_ayat WHERE sura = ${surahId} AND ayah >= ${startAya} ORDER BY ayah`);
            
            if (result.length > 0) {
                endAyaSelect.innerHTML = '';
                const rows = result[0].values;
                
                rows.forEach(row => {
                    const [ayah, text] = row;
                    const option = document.createElement('option');
                    option.value = ayah;
                    const truncatedText = text.length > 80 ? text.substring(0, 80) + '...' : text;
                    option.textContent = `${ayah}. ${truncatedText}`;
                    endAyaSelect.appendChild(option);
                });
                
                const selectedOption = surahSelect.options[surahSelect.selectedIndex];
                const numAyat = parseInt(selectedOption.dataset.numAyat);
                endAyaSelect.value = Math.min(parseInt(startAya) + 5, numAyat);
                
                downloadBtn.disabled = false;
            }
        }

        downloadOfflineBtn.addEventListener('click', async () => {
            const checkboxes = surahCheckboxes.querySelectorAll('input[type="checkbox"]:checked');
            const selectedSurahs = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            if (selectedSurahs.length === 0) {
                showStatus('الرجاء اختيار سورة واحدة على الأقل', 'error');
                return;
            }
            
            downloadOfflineBtn.disabled = true;
            downloadProgress.style.display = 'block';
            
            for (let i = 0; i < selectedSurahs.length; i++) {
                const surahNum = selectedSurahs[i];
                const progress = Math.round(((i + 1) / selectedSurahs.length) * 100);
                progressBar.style.width = progress + '%';
                progressBar.textContent = `${progress}% - جاري تحميل السورة ${surahNum}`;
                
                try {
                    const surahStr = String(surahNum).padStart(3, '0');
                    const audioUrl = `https://download.tvquran.com/download/TvQuran.com__Yaseen/${surahStr}.mp3`;
                    const corsProxy = 'https://corsproxy.io/?';
                    const proxiedUrl = corsProxy + encodeURIComponent(audioUrl);
                    
                    const response = await fetch(proxiedUrl);
                    const arrayBuffer = await response.arrayBuffer();
                    await saveAudioToCache(surahNum, arrayBuffer);
                    
                    checkboxes[i].checked = false;
                } catch (error) {
                    console.error(`خطأ في تحميل السورة ${surahNum}:`, error);
                }
            }
            
            progressBar.style.width = '100%';
            progressBar.textContent = 'اكتمل التحميل!';
            await updateStoredSurahsList();
            
            setTimeout(() => {
                downloadProgress.style.display = 'none';
                downloadOfflineBtn.disabled = false;
                showStatus('تم حفظ السور بنجاح!', 'success');
            }, 1500);
        });

        function calculateTimes(surahNumber, startAya, endAya) {
            if (!db) throw new Error('قاعدة البيانات غير محملة');

            const surahStr = String(surahNumber).padStart(3, '0');
            
            let startTime = 0;
            if (startAya > 1) {
                for (let i = 1; i < startAya; i++) {
                    const ayaStr = `${surahStr}${String(i).padStart(3, '0')}`;
                    const result = db.exec(`SELECT duration FROM times WHERE aya = '${ayaStr}'`);
                    if (result.length > 0 && result[0].values.length > 0) {
                        startTime += result[0].values[0][0];
                    }
                }
            }

            let endTime = 0;
            for (let i = 1; i <= endAya; i++) {
                const ayaStr = `${surahStr}${String(i).padStart(3, '0')}`;
                const result = db.exec(`SELECT duration FROM times WHERE aya = '${ayaStr}'`);
                if (result.length > 0 && result[0].values.length > 0) {
                    endTime += result[0].values[0][0];
                } else {
                    throw new Error(`الآية ${i} غير موجودة في قاعدة البيانات للسورة ${surahNumber}`);
                }
            }

            return { startTime, endTime };
        }

        async function downloadAudioSegment() {
            const surahNumber = parseInt(surahSelect.value);
            const startAya = parseInt(startAyaSelect.value);
            const endAya = parseInt(endAyaSelect.value);

            if (!surahNumber || !startAya || !endAya) {
                showStatus('الرجاء اختيار جميع الحقول', 'error');
                return;
            }

            if (!db) {
                showStatus('قاعدة البيانات غير محملة بعد. الرجاء الانتظار...', 'error');
                return;
            }

            try {
                downloadBtn.disabled = true;
                previewAudio.style.display = 'none';
                infoBox.style.display = 'none';

                showStatus('جاري حساب الأوقات من قاعدة البيانات...', 'info');
                const { startTime, endTime } = calculateTimes(surahNumber, startAya, endAya);
                
                showInfo(`المدى الزمني: ${startTime.toFixed(2)}ث - ${endTime.toFixed(2)}ث (المدة: ${(endTime - startTime).toFixed(2)}ث)`);

                let arrayBuffer = await getAudioFromCache(surahNumber);
                
                if (!arrayBuffer) {
                    showStatus('جاري تحميل الملف الصوتي...', 'info');
                    const surahStr = String(surahNumber).padStart(3, '0');
                    const audioUrl = `https://download.tvquran.com/download/TvQuran.com__Yaseen/${surahStr}.mp3`;
                    const corsProxy = 'https://corsproxy.io/?';
                    const proxiedUrl = corsProxy + encodeURIComponent(audioUrl);
                    const response = await fetch(proxiedUrl);
                    if (!response.ok) throw new Error('فشل تحميل الملف الصوتي');
                    arrayBuffer = await response.arrayBuffer();
                } else {
                    showStatus('تم العثور على الملف في التخزين المحلي', 'success');
                }
                
                showStatus('جاري معالجة الصوت...', 'info');

                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

                const sampleRate = audioBuffer.sampleRate;
                const startSample = Math.floor(startTime * sampleRate);
                const endSample = Math.floor(endTime * sampleRate);
                const segmentLength = endSample - startSample;

                if (startSample < 0 || endSample > audioBuffer.length) {
                    throw new Error(`مدى زمني غير صحيح. مدة الصوت هي ${(audioBuffer.length / sampleRate).toFixed(2)} ثانية`);
                }

                const segmentBuffer = audioContext.createBuffer(
                    audioBuffer.numberOfChannels,
                    segmentLength,
                    sampleRate
                );

                for (let channel = 0; channel < audioBuffer.numberOfChannels; channel++) {
                    const sourceData = audioBuffer.getChannelData(channel);
                    const segmentData = segmentBuffer.getChannelData(channel);
                    for (let i = 0; i < segmentLength; i++) {
                        segmentData[i] = sourceData[startSample + i];
                    }
                }

                showStatus('جاري ترميز الصوت...', 'info');

                const wavBlob = bufferToWave(segmentBuffer);

                const previewUrl = URL.createObjectURL(wavBlob);
                previewAudio.src = previewUrl;
                previewAudio.style.display = 'block';

                const surahName = surahSelect.options[surahSelect.selectedIndex].textContent.split('. ')[1];
                const a = document.createElement('a');
                a.href = previewUrl;
                a.download = `${surahName}_آية${startAya}-${endAya}.wav`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                showStatus('اكتمل التحميل! المعاينة متاحة أدناه.', 'success');
            } catch (error) {
                showStatus(`خطأ: ${error.message}`, 'error');
                console.error(error);
            } finally {
                downloadBtn.disabled = false;
            }
        }

        function bufferToWave(audioBuffer) {
            const numChannels = audioBuffer.numberOfChannels;
            const sampleRate = audioBuffer.sampleRate;
            const format = 1;
            const bitDepth = 16;

            const length = audioBuffer.length * numChannels * 2;
            const buffer = new ArrayBuffer(44 + length);
            const view = new DataView(buffer);

            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + length, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, format, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * numChannels * bitDepth / 8, true);
            view.setUint16(32, numChannels * bitDepth / 8, true);
            view.setUint16(34, bitDepth, true);
            writeString(view, 36, 'data');
            view.setUint32(40, length, true);

            const channels = [];
            for (let i = 0; i < numChannels; i++) {
                channels.push(audioBuffer.getChannelData(i));
            }

            let offset = 44;
            for (let i = 0; i < audioBuffer.length; i++) {
                for (let channel = 0; channel < numChannels; channel++) {
                    const sample = Math.max(-1, Math.min(1, channels[channel][i]));
                    view.setInt16(offset, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
                    offset += 2;
                }
            }

            return new Blob([buffer], { type: 'audio/wav' });
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        surahSelect.addEventListener('change', loadAyasForSurah);
        startAyaSelect.addEventListener('change', updateEndAyaOptions);
        downloadBtn.addEventListener('click', downloadAudioSegment);

        initDatabase();
    </script>
</body>
</html>